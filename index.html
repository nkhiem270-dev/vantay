<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Chấm Công - Dữ Liệu Thực Tế</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            text-align: center;
        }
        h1 {
            margin: 0;
            font-size: 28px;
        }

        /* --- MAIN TABS --- */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #555;
            transition: background 0.3s;
        }
        .tab-btn.active {
            background: #e9ecef;
            font-weight: bold;
            color: #667eea;
        }
        .tab-content {
            display: none;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }

        /* --- SUB-TABS (trong dashboard) --- */
        .sub-tab-content {
            display: none;
        }
        .sub-tab-content.active {
            display: block;
        }

        /* --- PHẦN CHẤM CÔNG --- */
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        input, select, button {
            padding: 10px 15px;
            margin: 5px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        button {
            background: #ff5722;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #e64a19;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }
        .early-row { background: #e8f5e9; }
        .late-row { background: #ffebee; }
        .ontime-row { background: #fff3e0; }

        /* --- THỐNG KÊ & BIỂU ĐỒ --- */
        .stats {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .card {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 120px;
            font-size: 14px;
        }
        .early { border-left: 5px solid #4CAF50; }
        .late { border-left: 5px solid #f44336; }
        .ontime { border-left: 5px solid #FF9800; }

        .chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        .chart-box {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            padding: 10px;
        }
        canvas {
            max-width: 100%;
            height: 250px !important;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #777;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>HỆ THỐNG CHẤM CÔNG - DỮ LIỆU THỰC TẾ</h1>
    </header>

    <!-- MAIN TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('attendance')">Chấm Công</button>
        <button class="tab-btn" onclick="openTab('dashboard')">Biểu Đồ & Thống Kê</button>
    </div>

    <!-- TAB 1: CHẤM CÔNG -->
    <section id="attendance" class="tab-content active">
        <h2 style="text-align: center; margin-bottom: 15px;">Dữ liệu chấm công</h2>
        <div class="controls">
            <input type="text" id="searchName" placeholder="Tìm tên nhân viên...">
            <input type="date" id="filterDate">
            <button onclick="applyFilter()">Lọc</button>
            <button onclick="resetFilter()">Xem tất cả</button>
        </div>

        <table id="dataTable">
            <thead>
                <tr><th>Ngày</th><th>Họ Tên</th><th>Hành động</th><th>Giờ</th><th>Trạng thái</th></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div id="pagination" style="text-align: center; margin-top: 15px;"></div>
    </section>

    <!-- TAB 2: BIỂU ĐỒ & THỐNG KÊ -->
    <section id="dashboard" class="tab-content">
        <h2 style="text-align: center; margin-bottom: 15px;">Thống kê & Biểu đồ</h2>

        <!-- Sub-tabs -->
        <div class="tabs" style="margin-bottom: 20px;">
            <button class="tab-btn active" onclick="openSubTab('checkin')">Check-in</button>
            <button class="tab-btn" onclick="openSubTab('checkout')">Check-out</button>
            <button class="tab-btn" onclick="openSubTab('overview')">Tổng quan</button>
        </div>

        <!-- Check-in -->
        <div id="checkin" class="sub-tab-content active">
            <div class="stats" id="stats-checkin"></div>
            <div style="text-align: center; margin-bottom: 15px;">
                <label>
                    Hiển thị:
                    <select id="barTypeIn" onchange="renderCheckInCharts(getFilteredData())">
                        <option value="late">Ai đi muộn?</option>
                        <option value="early">Ai đi sớm?</option>
                        <option value="ontime">Ai đúng giờ?</option>
                    </select>
                </label>
            </div>
            <div class="chart-container">
                <div class="chart-box"><canvas id="pieChartIn"></canvas></div>
                <div class="chart-box"><canvas id="barChartIn"></canvas></div>
            </div>
        </div>

        <!-- Check-out -->
        <div id="checkout" class="sub-tab-content" style="display: none;">
            <div class="stats" id="stats-checkout"></div>
            <div style="text-align: center; margin-bottom: 15px;">
                <label>
                    Hiển thị:
                    <select id="barTypeOut" onchange="renderCheckOutCharts(getFilteredData())">
                        <option value="late">Ai về muộn?</option>
                        <option value="early">Ai về sớm?</option>
                        <option value="ontime">Ai đúng giờ?</option>
                    </select>
                </label>
            </div>
            <div class="chart-container">
                <div class="chart-box"><canvas id="pieChartOut"></canvas></div>
                <div class="chart-box"><canvas id="barChartOut"></canvas></div>
            </div>
        </div>

        <!-- Tổng quan -->
        <div id="overview" class="sub-tab-content" style="display: none;">
            <div class="stats" id="stats-overview"></div>
            <div class="chart-container">
                <div class="chart-box"><canvas id="pieChartAll"></canvas></div>
            </div>
        </div>
    </section>

    <footer>
        Cập nhật lúc: <span id="lastUpdate"></span>
    </footer>
</div>

<script>
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTicasy-IOQxPm0AycyqcWzxbwyX7ag-zrGvlTb-AyaqZ067jDCE4snGAvufdFRF0u4nH9zBGMZ42ru/pub?gid=0&single=true&output=csv';

let allData = [];
let currentPage = 1;
const rowsPerPage = 13;

// Biểu đồ
let chartPieIn = null, chartBarIn = null;
let chartPieOut = null, chartBarOut = null;
let chartPieAll = null;

function timeToMinutes(t) {
    if (!t || t.includes('-')) return NaN;
    const [h, m] = t.split(':').map(Number);
    return h * 60 + m;
}

function classify(timeStr, type) {
    if (!timeStr || timeStr.includes('-')) return {text: "—", color: "#999"};
    const mins = timeToMinutes(timeStr);
    if (type === "in") {
        if (mins <= 480) return {text: "Đi sớm", color: "#4CAF50"};
        if (mins > 480 && mins <= 510) return {text: "Đúng giờ", color: "#FF9800"};
        return {text: "Đi muộn", color: "#f44336"};
    } else {
        if (mins < 1050) return {text: "Về sớm", color: "#4CAF50"};
        if (mins >= 1050 && mins <= 1080) return {text: "Đúng giờ", color: "#FF9800"};
        return {text: "Về muộn", color: "#f44336"};
    }
}

function formatDate(dateStr) {
    const parts = dateStr.split('/');
    if (parts.length !== 3) return dateStr;
    return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
}

// --- MAIN TABS ---
function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

    document.getElementById(tabName).classList.add('active');
    document.querySelector(`.tab-btn[onclick="openTab('${tabName}')"]`).classList.add('active');

    if (tabName === 'dashboard') {
        openSubTab('checkin');
    }
}

// --- SUB-TABS ---
function openSubTab(tabName) {
    document.querySelectorAll('.sub-tab-content').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
    });
    document.querySelectorAll('#dashboard .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    const tab = document.getElementById(tabName);
    tab.classList.add('active');
    tab.style.display = 'block';
    event.target.classList.add('active');

    const filtered = getFilteredData();
    if (tabName === 'checkin') {
        renderCheckInStats(filtered);
        renderCheckInCharts(filtered);
    } else if (tabName === 'checkout') {
        renderCheckOutStats(filtered);
        renderCheckOutCharts(filtered);
    } else if (tabName === 'overview') {
        renderOverviewStats(filtered);
        renderOverviewChart(filtered);
    }
}

function getFilteredData() {
    const name = document.getElementById('searchName').value.trim();
    const date = document.getElementById('filterDate').value;
    return allData.filter(row => {
        const nameMatch = name === '' || row.name.toLowerCase().startsWith(name.toLowerCase());
        const dateMatch = !date || formatDate(row.date) === date;
        return nameMatch && dateMatch;
    });
}

// --- LỌC (KHÔNG RESET currentPage) ---
function applyFilter() {
    const filtered = getFilteredData();
    renderPaginatedTable(filtered);

    if (document.getElementById('dashboard').classList.contains('active')) {
        const activeSubTab = document.querySelector('.sub-tab-content.active');
        if (activeSubTab) {
            const id = activeSubTab.id;
            if (id === 'checkin') {
                renderCheckInStats(filtered);
                renderCheckInCharts(filtered);
            } else if (id === 'checkout') {
                renderCheckOutStats(filtered);
                renderCheckOutCharts(filtered);
            } else if (id === 'overview') {
                renderOverviewStats(filtered);
                renderOverviewChart(filtered);
            }
        }
    }
}

// --- RESET LỌC → TRANG 1 ---
function resetFilter() {
    currentPage = 1;
    document.getElementById('searchName').value = '';
    document.getElementById('filterDate').value = '';
    applyFilter();
}

// --- CHUYỂN TRANG ---
function changePage(page) {
    currentPage = page;
    const filtered = getFilteredData();
    renderPaginatedTable(filtered);
}

// --- RENDER BẢNG + PHÂN TRANG ---
function renderPaginatedTable(data) {
    const tbody = document.getElementById('tableBody');
    const paginationEl = document.getElementById('pagination');
    tbody.innerHTML = '';
    paginationEl.innerHTML = '';

    const totalRows = data.length;
    const totalPages = Math.ceil(totalRows / rowsPerPage);
    if (totalPages === 0) currentPage = 1;
    if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;

    const startIndex = (currentPage - 1) * rowsPerPage;
    const paginatedData = data.slice(startIndex, startIndex + rowsPerPage);

    paginatedData.forEach(row => {
        const status = classify(row.time, row.action.includes('in') ? 'in' : 'out');
        const tr = document.createElement('tr');
        if (status.color === '#4CAF50') tr.classList.add('early-row');
        else if (status.color === '#f44336') tr.classList.add('late-row');
        else if (status.color === '#FF9800') tr.classList.add('ontime-row');

        tr.innerHTML = `
          <td>${row.date}</td>
          <td>${row.name}</td>
          <td>${row.action}</td>
          <td>${row.time}</td>
          <td style="color:${status.color}; font-weight:bold">${status.text}</td>
        `;
        tbody.appendChild(tr);
    });

    if (totalPages <= 1) return;

    let html = '';
    if (currentPage > 1) {
        html += `<button onclick="changePage(${currentPage - 1})" style="margin: 0 5px; padding: 6px 10px;">«</button>`;
    }

    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    if (endPage - startPage + 1 < maxVisible) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<span style="margin: 0 5px; font-weight: bold; color: #667eea;">${i}</span>`;
        } else {
            html += `<button onclick="changePage(${i})" style="margin: 0 5px; padding: 6px 10px;">${i}</button>`;
        }
    }

    if (currentPage < totalPages) {
        html += `<button onclick="changePage(${currentPage + 1})" style="margin: 0 5px; padding: 6px 10px;">»</button>`;
    }

    paginationEl.innerHTML = html;
}

// --- THỐNG KÊ ---
function renderCheckInStats(data) {
    const inData = data.filter(r => r.action.includes('in'));
    const early = inData.filter(r => classify(r.time, 'in').color === '#4CAF50').length;
    const ontime = inData.filter(r => classify(r.time, 'in').color === '#FF9800').length;
    const late = inData.length - early - ontime;
    document.getElementById('stats-checkin').innerHTML = `
        <div class="card early"><h3>${early}</h3><p>Đi sớm</p></div>
        <div class="card ontime"><h3>${ontime}</h3><p>Đúng giờ</p></div>
        <div class="card late"><h3>${late}</h3><p>Đi muộn</p></div>
    `;
}

function renderCheckOutStats(data) {
    const outData = data.filter(r => r.action.includes('out'));
    const early = outData.filter(r => classify(r.time, 'out').color === '#4CAF50').length;
    const ontime = outData.filter(r => classify(r.time, 'out').color === '#FF9800').length;
    const late = outData.length - early - ontime;
    document.getElementById('stats-checkout').innerHTML = `
        <div class="card early"><h3>${early}</h3><p>Về sớm</p></div>
        <div class="card ontime"><h3>${ontime}</h3><p>Đúng giờ</p></div>
        <div class="card late"><h3>${late}</h3><p>Về muộn</p></div>
    `;
}

function renderOverviewStats(data) {
    let earlyIn = 0, lateIn = 0, onTimeIn = 0;
    let earlyOut = 0, lateOut = 0, onTimeOut = 0;

    data.forEach(row => {
        const c = classify(row.time, row.action.includes('in') ? 'in' : 'out');
        if (row.action.includes('in')) {
            if (c.color === '#4CAF50') earlyIn++;
            else if (c.color === '#f44336') lateIn++;
            else onTimeIn++;
        } else {
            if (c.color === '#4CAF50') earlyOut++;
            else if (c.color === '#f44336') lateOut++;
            else onTimeOut++;
        }
    });

    document.getElementById('stats-overview').innerHTML = `
        <div class="card early"><h3>${earlyIn}</h3><p>Đi sớm</p></div>
        <div class="card ontime"><h3>${onTimeIn}</h3><p>Vào đúng</p></div>
        <div class="card late"><h3>${lateIn}</h3><p>Đi muộn</p></div>
        <div class="card early"><h3>${earlyOut}</h3><p>Về sớm</p></div>
        <div class="card ontime"><h3>${onTimeOut}</h3><p>Ra đúng</p></div>
        <div class="card late"><h3>${lateOut}</h3><p>Về muộn</p></div>
    `;
}

// --- BIỂU ĐỒ ---
function renderCheckInCharts(data) {
    const inData = data.filter(r => r.action.includes('in'));
    const early = inData.filter(r => classify(r.time, 'in').color === '#4CAF50').length;
    const late = inData.filter(r => classify(r.time, 'in').color === '#f44336').length;
    const ontime = inData.length - early - late;

    if (chartPieIn) chartPieIn.destroy();
    const ctx1 = document.getElementById('pieChartIn').getContext('2d');
    chartPieIn = new Chart(ctx1, {
        type: 'doughnut',
         {
            labels: ['Đi sớm', 'Đúng giờ', 'Đi muộn'],
            datasets: [{
                 [early, ontime, late],
                backgroundColor: ['#4CAF50', '#FF9800', '#f44336']
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { title: { display: true, text: 'Check-in' } }
        }
    });

    const barType = document.getElementById('barTypeIn').value;
    let label = '', color = '';
    let filteredData = [];

    if (barType === 'late') {
        label = 'Đi muộn';
        color = '#f44336';
        filteredData = inData.filter(r => classify(r.time, 'in').color === '#f44336');
    } else if (barType === 'early') {
        label = 'Đi sớm';
        color = '#4CAF50';
        filteredData = inData.filter(r => classify(r.time, 'in').color === '#4CAF50');
    } else if (barType === 'ontime') {
        label = 'Đúng giờ';
        color = '#FF9800';
        filteredData = inData.filter(r => classify(r.time, 'in').color === '#FF9800');
    }

    const names = [...new Set(inData.map(r => r.name))];
    const counts = names.map(n => filteredData.filter(r => r.name === n).length);

    if (chartBarIn) chartBarIn.destroy();
    const ctx2 = document.getElementById('barChartIn').getContext('2d');
    chartBarIn = new Chart(ctx2, {
        type: 'bar',
         {
            labels: names,
            datasets: [{
                label: label,
                 counts,
                backgroundColor: color
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { title: { display: true, text: `Ai ${label.toLowerCase()}?` } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });
}

function renderCheckOutCharts(data) {
    const outData = data.filter(r => r.action.includes('out'));
    const early = outData.filter(r => classify(r.time, 'out').color === '#4CAF50').length;
    const late = outData.filter(r => classify(r.time, 'out').color === '#f44336').length;
    const ontime = outData.length - early - late;

    if (chartPieOut) chartPieOut.destroy();
    const ctx1 = document.getElementById('pieChartOut').getContext('2d');
    chartPieOut = new Chart(ctx1, {
        type: 'doughnut',
         {
            labels: ['Về sớm', 'Đúng giờ', 'Về muộn'],
            datasets: [{
                 [early, ontime, late],
                backgroundColor: ['#4CAF50', '#FF9800', '#f44336']
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { title: { display: true, text: 'Check-out' } }
        }
    });

    const barType = document.getElementById('barTypeOut').value;
    let label = '', color = '';
    let filteredData = [];

    if (barType === 'late') {
        label = 'Về muộn';
        color = '#f44336';
        filteredData = outData.filter(r => classify(r.time, 'out').color === '#f44336');
    } else if (barType === 'early') {
        label = 'Về sớm';
        color = '#4CAF50';
        filteredData = outData.filter(r => classify(r.time, 'out').color === '#4CAF50');
    } else if (barType === 'ontime') {
        label = 'Đúng giờ';
        color = '#FF9800';
        filteredData = outData.filter(r => classify(r.time, 'out').color === '#FF9800');
    }

    const names = [...new Set(outData.map(r => r.name))];
    const counts = names.map(n => filteredData.filter(r => r.name === n).length);

    if (chartBarOut) chartBarOut.destroy();
    const ctx2 = document.getElementById('barChartOut').getContext('2d');
    chartBarOut = new Chart(ctx2, {
        type: 'bar',
         {
            labels: names,
            datasets: [{
                label: label,
                 counts,
                backgroundColor: color
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { title: { display: true, text: `Ai ${label.toLowerCase()}?` } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });
}

function renderOverviewChart(data) {
    let earlyIn = 0, lateIn = 0, onTimeIn = 0;
    let earlyOut = 0, lateOut = 0, onTimeOut = 0;

    data.forEach(row => {
        const c = classify(row.time, row.action.includes('in') ? 'in' : 'out');
        if (row.action.includes('in')) {
            if (c.color === '#4CAF50') earlyIn++;
            else if (c.color === '#f44336') lateIn++;
            else onTimeIn++;
        } else {
            if (c.color === '#4CAF50') earlyOut++;
            else if (c.color === '#f44336') lateOut++;
            else onTimeOut++;
        }
    });

    if (chartPieAll) chartPieAll.destroy();
    const ctx = document.getElementById('pieChartAll').getContext('2d');
    chartPieAll = new Chart(ctx, {
        type: 'doughnut',
         {
            labels: ['Đi sớm', 'Vào đúng', 'Đi muộn', 'Về sớm', 'Ra đúng', 'Về muộn'],
            datasets: [{
                 [earlyIn, onTimeIn, lateIn, earlyOut, onTimeOut, lateOut],
                backgroundColor: ['#4CAF50', '#FF9800', '#f44336', '#81C784', '#FFB74D', '#E57373']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { title: { display: true, text: 'Tổng quan chấm công' } }
        }
    });
}

// --- LOAD DỮ LIỆU ---
function loadData() {
    fetch(SHEET_URL)
        .then(r => r.text())
        .then(csv => {
            const rows = csv
                .split('\n')
                .map(line => line.split(',').map(c => c.replace(/^"|"$/g, '').trim()))
                .filter(row => row.length >= 5);

            allData = rows.slice(1)
                .filter(r => r[1] && r[0] && r[3] && r[4])
                .map(row => ({
                    date: row[0],
                    name: row[1],
                    action: row[3],
                    time: row[4]
                }));

            applyFilter();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('vi-VN');
        })
        .catch(err => {
            console.error("Lỗi khi tải dữ liệu:", err);
            document.getElementById('lastUpdate').textContent = "Lỗi kết nối";
        });
}

window.onload = () => {
    loadData();
    document.getElementById('searchName').addEventListener('input', applyFilter);
    document.getElementById('filterDate').addEventListener('change', applyFilter);
};

setInterval(loadData, 15000);
</script>
</body>
</html>

