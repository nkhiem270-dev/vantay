<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Chấm Công - Dữ Liệu Thực Tế</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding:20px;}
        .container {max-width:1300px; margin:auto; background:white; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1); overflow:hidden;}
        header {background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:25px; text-align:center;}
        h1 {margin:0; font-size:28px;}
        .controls {padding:20px; text-align:center; background:#f8f9fa;}
        input, select, button {padding:10px 15px; margin:5px; font-size:16px; border-radius:8px; border:1px solid #ddd;}
        button {background:#ff5722; color:white; border:none; cursor:pointer;}
        button:hover {background:#e64a19;}
        .stats {display:flex; justify-content:center; flex-wrap:wrap; gap:20px; padding:20px;}
        .card {background:#fff; padding:20px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1); text-align:center; min-width:150px;}
        .early {border-left:6px solid #4CAF50;}
        .late {border-left:6px solid #f44336;}
        .ontime {border-left:6px solid #FF9800;}
        .charts {display:flex; flex-wrap:wrap; justify-content:center; gap:20px; padding:20px;}
        canvas {background:white; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
        table {width:100%; border-collapse:collapse; margin:20px;}
        th, td {padding:12px; text-align:center; border-bottom:1px solid #eee;}
        th {background:#f8f9fa; position:sticky; top:0;}
        .early-row {background:#e8f5e9;}
        .late-row {background:#ffebee;}
        .ontime-row {background:#fff3e0;}
        footer {text-align:center; padding:20px; background:#f8f9fa; color:#777;}
    </style>
</head>
<body>
<div class="container">
    <header><h1>HỆ THỐNG CHẤM CÔNG - DỮ LIỆU THỰC TẾ</h1></header>
    
    <div class="controls">
        <input type="text" id="searchName" placeholder="Tìm tên nhân viên...">
        <input type="date" id="filterDate">
        <button onclick="applyFilter()">Lọc</button>
        <button onclick="resetFilter()">Xem tất cả</button>
    </div>

    <div class="stats" id="stats"></div>
    <div class="charts">
        <canvas id="pieChart" width="140" height="140"></canvas>
        <canvas id="barChart" width="600" height="400"></canvas>
    </div>

    <table id="dataTable">
        <thead>
            <tr><th>Ngày</th><th>Họ Tên</th><th>Hành động</th><th>Giờ</th><th>Trạng thái</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <footer>Cập nhật lúc: <span id="lastUpdate"></span></footer>
</div>

<script>
// LINK CHÍNH XÁC TỪ TAB DATASHEET CỦA BẠN
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTicasy-IOQxPm0AycyqcWzxbwyX7ag-zrGvlTb-AyaqZ067jDCE4snGAvufdFRF0u4nH9zBGMZ42ru/pub?gid=0&single=true&output=csv';

let allData = [];
let chartPie, chartBar;

function timeToMinutes(t) {
    const [h, m] = t.split(':').map(Number);
    return h*60 + m;
}

function classify(timeStr, type) {
    if (!timeStr || timeStr.includes('-')) return {text:"—", color:"#999"};
    const mins = timeToMinutes(timeStr);
    if (type === "in") {
        if (mins <= 480) return {text:"Đi sớm", color:"#4CAF50"};      // ≤ 8:00
        if (mins > 480 && mins <= 510) return {text:"Đúng giờ", color:"#FF9800"}; // 8:00 - 8:30
        return {text:"Đi muộn", color:"#f44336"};
    } else { // check out
        if (mins < 1050) return {text:"Về sớm", color:"#4CAF50"};      // < 17:30
        if (mins >= 1050 && mins <= 1080) return {text:"Đúng giờ", color:"#FF9800"}; // 17:30-18:00
        return {text:"Về muộn", color:"#f44336"};
    }
}

function formatDate(dateStr) {
    const parts = dateStr.split('/');
    if (parts.length !== 3) return dateStr;
    return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
}

function applyFilter() {
    const name = document.getElementById('searchName').value.trim();
    const date = document.getElementById('filterDate').value;

    const filtered = allData.filter(row => {
        // Chỉ lọc theo chữ cái đầu của tên
        const nameMatch = name === '' || row.name.toLowerCase().startsWith(name.toLowerCase());
        const dateMatch = !date || formatDate(row.date) === date;
        return nameMatch && dateMatch;
    });

    renderTable(filtered);
    renderStats(filtered);
    renderCharts(filtered);

}

function resetFilter() {
    document.getElementById('searchName').value = '';
    document.getElementById('filterDate').value = '';
    applyFilter();
}

function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    data.forEach(row => {
        const status = classify(row.time, row.action.includes('in') ? 'in' : 'out');
        const tr = document.createElement('tr');
        if (status.color === '#4CAF50') tr.classList.add('early-row');
        if (status.color === '#f44336') tr.classList.add('late-row');
        if (status.color === '#FF9800') tr.classList.add('ontime-row');

        tr.innerHTML = `<td>${row.date}</td><td>${row.name}</td><td>${row.action}</td><td>${row.time}</td>
                        <td style="color:${status.color};font-weight:bold">${status.text}</td>`;
        tbody.appendChild(tr);
    });
}

function renderStats(data) {
    let earlyIn = 0, lateIn = 0, onTimeIn = 0;
    let earlyOut = 0, lateOut = 0, onTimeOut = 0;

    data.forEach(row => {
        const c = classify(row.time, row.action.includes('in') ? 'in' : 'out');
        if (row.action.includes('in')) {
            if (c.color==='#4CAF50') earlyIn++;
            else if (c.color==='#f44336') lateIn++;
            else onTimeIn++;
        } else {
            if (c.color==='#4CAF50') earlyOut++;
            else if (c.color==='#f44336') lateOut++;
            else onTimeOut++;
        }
    });

    document.getElementById('stats').innerHTML = `
        <div class="card early"><h2>${earlyIn}</h2><p>Đi sớm</p></div>
        <div class="card late"><h2>${lateIn}</h2><p>Đi muộn</p></div>
        <div class="card ontime"><h2>${onTimeIn}</h2><p>Đúng giờ (vào)</p></div>
        <div class="card early"><h2>${earlyOut}</h2><p>Về sớm</p></div>
        <div class="card late"><h2>${lateOut}</h2><p>Về muộn</p></div>
        <div class="card ontime"><h2>${onTimeOut}</h2><p>Đúng giờ (ra)</p></div>
    `;
}

function renderCharts(data) {
    // Biểu đồ tròn
    const inData = data.filter(r => r.action.includes('in'));
    const earlyIn = inData.filter(r => classify(r.time,'in').color==='#4CAF50').length;
    const lateIn = inData.filter(r => classify(r.time,'in').color==='#f44336').length;
    const onTimeIn = inData.length - earlyIn - lateIn;

    if (chartPie) chartPie.destroy();
    chartPie = new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: {labels:['Đi sớm','Đúng giờ','Đi muộn'], datasets:[{data:[earlyIn,onTimeIn,lateIn], backgroundColor:['#4CAF50','#FF9800','#f44336']}]},
        options: {plugins:{title:{display:true,text:'Tỷ lệ đi làm đúng giờ'}}}
    });

    // Biểu đồ cột theo tên
    const names = [...new Set(data.map(r => r.name))];
    const lateCounts = names.map(n => data.filter(r => r.name===n && r.action.includes('in') && classify(r.time,'in').color==='#f44336').length);

    if (chartBar) chartBar.destroy();
    chartBar = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {labels: names, datasets:[{label:'Số lần đi muộn', data: lateCounts, backgroundColor:'#f44336'}]},
        options: {plugins:{title:{display:true,text:'Ai hay đi muộn nhất?'}}, scales:{y:{beginAtZero:true}}}
    });
}

function loadData() {
    fetch(SHEET_URL)
        .then(r => r.text())
        .then(csv => {
            const rows = csv.split('\n').map(line => line.split(',').map(c => c.replace(/^"|"$/g,'').trim()));
            allData = rows.slice(2).filter(r => r[1]).map(row => ({ // bỏ 2 dòng header
                date: row[0],
                name: row[1],
                action: row[3],
                time: row[4]
            }));
            applyFilter();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('vi-VN');
        });
}

window.onload = loadData;
document.getElementById('searchName').addEventListener('input', applyFilter);
document.getElementById('filterDate').addEventListener('change', applyFilter);
</script>
</body>
</html>